FROM debian:bookworm-slim

ARG INSTALL_CLAUDE=false

# OpenCode is included for in-container development.
# It is not currently supported when doing agentic verification.

RUN apt-get update \
 && apt-get install -y npm git curl \
 && npm install -g opencode-ai @openai/codex \
 && curl -LsSf https://astral.sh/uv/install.sh | sh

WORKDIR /app

# Container is ephemeral â€” grant OpenCode full permissions so non-interactive
# `opencode run` never auto-rejects (e.g. external_directory access to /tmp).
ENV OPENCODE_PERMISSION='{"*":"allow","external_directory":{"*":"allow"}}'
RUN git config --global --add safe.directory /app
RUN /root/.local/bin/uv tool install verify-everything

RUN if [ "$INSTALL_CLAUDE" = "true" ]; then \
      npm install -g @anthropic-ai/claude-code; \
fi
